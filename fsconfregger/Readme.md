# Problem

# How does it work?

fsconfregger runs on BigBlueButton servers and is listening on FreeSWITCH Eventsocket.
When a new conference room is created an external script is executed.
The script generates a custom XML snippet which includes the SIP registration information for FreeSWITCH.
After the script is finished, FreeSWITCH gets instructed to reload the XML config and starts to register.

In combination with a central SIP Registrar server (like Kamailio or Asterisk) you are now able to
route incoming SIP calls to the correct BigBlueButton instance.

After all participants left the Room, the registration is cleaned up.

To have stable conference numbers BBB requires you to set the parameter *voiceBridge* accordincly when the rooms is created.
At the moment Greenlight does not support this. So you are required to adapt it or find another way.

## Operation

fsconfregger is required to run on the same machine as FreeSWITCH.
If you are running multiple BBB servers this means you need one fsconfregger process on every BBB-Server.

You are required to have a properly configured SIP registrar which accepts the Registrations which are generated by the script.

Just adapt the systemd unitfile and the XML Generator script to your needs.

### Steps

Example steps to build and setup on a BBB node.
You propably want to build it once and deploy everything with ansible.

```
# install golang on ubuntu 16.04
apt install golang-1.10 git

# get and build fsconfregger
git clone https://github.com/MBcom/bbb-clustersip.git
cd bbb-clustersip
go build

cp fsconfregger sofia-generator.sh /usr/local/sbin/
cp fsconfregger.sample /etc/default/fsconfregger
cp fsconfregger.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable fsconfregger
systemctl start fsconfregger
```

copy the password from `/opt/freeswitch/conf/autoload_configs/event_socket.conf.xml` and paste it to `/etc/default/fsconfregger`. Then restart the fsconfregger service `systemctl restart fsconfregger`.

And insert the following in `/opt/freeswitch/conf/dialplan/public/sip-gw.xml` and insert the IP of your SIP Gateway Server (where asterisk runs) in the `expression` field. 

```xml
<extension name="from_asterisk">
 <condition field="network_addr" expression="<the IP of the SIP gateway server>" />
 <condition field="destination_number" expression="^(\d+)">
         <action application="set_profile_var" data="caller_id_name=${regex(${caller_id_name}|^.*(.{4})$|xxx-xxx-%1)}"/>
   <action application="set" data="bbb_authorized=true"/>
   <action application="transfer" data="$1 XML default"/>
 </condition>
</extension>
```

Now run - and make sure that no conference is actually running.
```bash
systemctl restart freeswitch
systemctl restart fsconfregger
```

## following for manual use only
### Parameters

| Parameter | Default              | Description                                             |
|-----------|----------------------|---------------------------------------------------------|
| -eshost   | localhost            | "FreeSWITCH Event Socket Host (default 'localhost')     |
| -esport   | 8021                 | FreeSWITCH Event Socket Port (default 8021)             |
| -espw     | ClueCon              | FreeSWITCH Event Socket Password (default 'ClueCon')    |
| -script   | ./sofia-generator.sh | "Path to XML Generator (default ./sofia-generator.sh)") |

### Script parameters

When a room is created the script is called with only one parameter:
* the room number

When a room is destroyed the script is called with two parameters:
* room number
* static string: 'del'

See sofia-generator.sh for an example.
